<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Swim Controller V9</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap');
    body { font-family: 'Roboto Mono', monospace; background-color: #000; color: white; margin: 0; overflow: hidden; }
    .digital-font { font-variant-numeric: tabular-nums; letter-spacing: -5px; }
    .scroll-container { height: calc(100vh - 420px); overflow-y: auto; padding-bottom: 120px; }

    /* Responsive timer sizing - uses smaller of width or height */
    .timer-display {
      font-size: min(45vw, 70vh);
      line-height: 1;
    }

    /* Landscape-specific adjustments */
    @media (orientation: landscape) {
      .timer-display {
        font-size: min(35vw, 65vh);
      }
      .scroll-container {
        height: calc(100vh - 300px);
      }
    }

    /* Small height screens (landscape mobile) */
    @media (max-height: 500px) {
      .timer-display {
        font-size: min(30vw, 60vh);
      }
    }

    /* Pulse Animations */
    @keyframes pulse-red { 0% { background-color: #000; } 30% { background-color: #ef4444; } 100% { background-color: #000; } }
    @keyframes pulse-orange { 0% { background-color: #000; } 30% { background-color: #f97316; } 100% { background-color: #000; } }
    @keyframes flash-green { 0% { background-color: #22c55e; } 100% { background-color: #000; } }
    @keyframes pulse-rest-final { 0% { background-color: #f97316; } 30% { background-color: #9a3412; } 100% { background-color: #f97316; } }

    .do-pulse-red { animation: pulse-red 0.7s ease-out; }
    .do-pulse-orange { animation: pulse-orange 0.7s ease-out; }
    .do-flash-green { animation: flash-green 0.8s ease-out; }
    .do-pulse-rest-final { animation: pulse-rest-final 0.7s ease-out; }

    /* Touch lock overlay */
    .touch-locked::after {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    function App() {
      const [mode, setMode] = useState('SETUP');
      const [workout, setWorkout] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [defaultRest, setDefaultRest] = useState(60);

      const [inReps, setInReps] = useState('4');
      const [inDist, setInDist] = useState('100 Free');
      const [inMin, setInMin] = useState('1');
      const [inSec, setInSec] = useState('30');

      const [currentBlockIndex, setCurrentBlockIndex] = useState(0);
      const [currentRep, setCurrentRep] = useState(1);
      const [timer, setTimer] = useState(0);
      const [isActive, setIsActive] = useState(false);
      const [tickToken, setTickToken] = useState(0);

      // New state for settings and features
      const [showSettings, setShowSettings] = useState(false);
      const [touchLockEnabled, setTouchLockEnabled] = useState(false);
      const [touchLocked, setTouchLocked] = useState(false);
      const [unlockKey, setUnlockKey] = useState('VolumeUp'); // Default unlock key

      // Refs for persistent timing
      const startTimeRef = useRef(null);
      const accumulatedTimeRef = useRef(0);
      const wakeLockRef = useRef(null);

      const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
      };

      // Wake Lock API - keeps screen on
      const requestWakeLock = useCallback(async () => {
        if ('wakeLock' in navigator) {
          try {
            wakeLockRef.current = await navigator.wakeLock.request('screen');
            console.log('Wake Lock acquired');
          } catch (err) {
            console.log('Wake Lock failed:', err);
          }
        }
      }, []);

      const releaseWakeLock = useCallback(() => {
        if (wakeLockRef.current) {
          wakeLockRef.current.release();
          wakeLockRef.current = null;
          console.log('Wake Lock released');
        }
      }, []);

      // Handle wake lock based on timer state
      useEffect(() => {
        if (isActive && mode === 'RUN') {
          requestWakeLock();
        } else {
          releaseWakeLock();
        }
        return () => releaseWakeLock();
      }, [isActive, mode, requestWakeLock, releaseWakeLock]);

      // Re-acquire wake lock on visibility change (handles screen off/on)
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (document.visibilityState === 'visible' && isActive && mode === 'RUN') {
            requestWakeLock();
          }
        };
        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
      }, [isActive, mode, requestWakeLock]);

      // Touch lock - listen for physical button to unlock
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (touchLocked && (e.key === unlockKey || e.code === unlockKey ||
              e.key === 'VolumeUp' || e.key === 'VolumeDown' ||
              e.code === 'VolumeUp' || e.code === 'VolumeDown')) {
            e.preventDefault();
            setTouchLocked(false);
          }
        };

        if (touchLocked) {
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }
      }, [touchLocked, unlockKey]);

      // Auto-enable touch lock when timer starts (if feature is enabled)
      useEffect(() => {
        if (touchLockEnabled && isActive && mode === 'RUN') {
          setTouchLocked(true);
        }
      }, [isActive, touchLockEnabled, mode]);

      const handleAddOrUpdate = () => {
        const mins = parseInt(inMin) || 0;
        const secs = parseInt(inSec) || 0;
        const reps = parseInt(inReps) || 1;
        const totalSeconds = (mins * 60) + secs;
        if (totalSeconds <= 0) return;

        const newBlock = { type: 'swim', reps, dist: inDist || "Swim", interval: totalSeconds };
        let newWorkout = [...workout];

        if (editingIndex !== null) {
          newWorkout[editingIndex] = newBlock;
          setEditingIndex(null);
        } else {
          if (newWorkout.length > 0 && newWorkout[newWorkout.length - 1].type !== 'rest') {
            newWorkout.push({ type: 'rest', duration: parseInt(defaultRest) || 60 });
          }
          newWorkout.push(newBlock);
        }
        setWorkout(newWorkout);
        setInDist('');
      };

      // Robust timer that survives background/visibility changes
      useEffect(() => {
        let interval = null;
        let lastTick = Date.now();

        if (isActive && mode === 'RUN') {
          // Store start time when timer begins
          if (startTimeRef.current === null) {
            startTimeRef.current = Date.now();
            accumulatedTimeRef.current = timer;
          }

          interval = setInterval(() => {
            const now = Date.now();
            // Calculate elapsed time from start, handling background pauses
            const elapsedSinceStart = Math.floor((now - startTimeRef.current) / 1000);
            const newTimer = accumulatedTimeRef.current + elapsedSinceStart;

            // Check if significant time passed (app was in background)
            const tickDelta = now - lastTick;
            if (tickDelta > 1500) {
              console.log('Timer recovered from background, delta:', tickDelta);
            }
            lastTick = now;

            setTimer(newTimer);
            setTickToken(Date.now());
          }, 250); // Check more frequently for responsiveness
        } else {
          // Timer paused - save accumulated time
          if (startTimeRef.current !== null) {
            accumulatedTimeRef.current = timer;
            startTimeRef.current = null;
          }
        }
        return () => clearInterval(interval);
      }, [isActive, mode]);

      useEffect(() => {
        if (!isActive || mode !== 'RUN') return;
        const block = workout[currentBlockIndex];
        if (!block) return;
        const limit = isRest ? block.duration : block.interval;

        if (timer >= limit) {
          // Reset timer refs for new interval
          startTimeRef.current = Date.now();
          accumulatedTimeRef.current = 0;
          setTimer(0);
          if (isRest || currentRep >= block.reps) {
            setCurrentBlockIndex(prev => prev + 1);
            setCurrentRep(1);
          } else {
            setCurrentRep(prev => prev + 1);
          }
        }
      }, [timer, isActive]);

      const block = workout[currentBlockIndex];
      const isRest = block?.type === 'rest';

      // Settings Modal
      const SettingsModal = () => (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowSettings(false)}>
          <div className="bg-slate-900 rounded-xl p-6 max-w-md w-full border border-slate-700" onClick={e => e.stopPropagation()}>
            <h2 className="text-xl font-bold text-blue-400 mb-6">Settings</h2>

            {/* Touch Lock Toggle */}
            <div className="mb-6">
              <div className="flex items-center justify-between mb-2">
                <label className="text-white font-medium">Touch Lock</label>
                <button
                  onClick={() => setTouchLockEnabled(!touchLockEnabled)}
                  className={`w-14 h-8 rounded-full transition-colors ${touchLockEnabled ? 'bg-green-600' : 'bg-slate-600'}`}
                >
                  <div className={`w-6 h-6 bg-white rounded-full transition-transform mx-1 ${touchLockEnabled ? 'translate-x-6' : ''}`}></div>
                </button>
              </div>
              <p className="text-slate-400 text-sm">
                When enabled, touch input is disabled during timer. Press volume button to unlock.
              </p>
            </div>

            {/* Unlock Key Selection */}
            <div className="mb-6">
              <label className="text-white font-medium block mb-2">Unlock Button</label>
              <select
                value={unlockKey}
                onChange={e => setUnlockKey(e.target.value)}
                className="w-full bg-black p-3 rounded border border-slate-700 text-white"
              >
                <option value="VolumeUp">Volume Up</option>
                <option value="VolumeDown">Volume Down</option>
                <option value="Space">Spacebar</option>
                <option value="Escape">Escape Key</option>
              </select>
              <p className="text-slate-400 text-sm mt-1">
                Physical button to re-enable touch input.
              </p>
            </div>

            {/* Wake Lock Info */}
            <div className="mb-6 p-4 bg-slate-800 rounded-lg">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-green-400">●</span>
                <span className="text-white font-medium">Screen Stay-On</span>
              </div>
              <p className="text-slate-400 text-sm">
                Screen will stay on automatically while the timer is running.
              </p>
            </div>

            <button
              onClick={() => setShowSettings(false)}
              className="w-full py-3 bg-blue-600 rounded-lg font-bold"
            >
              DONE
            </button>
          </div>
        </div>
      );

      if (mode === 'SETUP') {
        return (
          <div className="h-screen flex flex-col bg-slate-950 p-4">
            {showSettings && <SettingsModal />}
            <div className="flex justify-between items-center mb-4">
              <h1 className="text-xl font-bold text-blue-400">Practice Setup</h1>
              <div className="flex items-center gap-3">
                <span className="text-slate-400">{workout.length} items</span>
                <button
                  onClick={() => setShowSettings(true)}
                  className="p-2 rounded-lg bg-slate-800 border border-slate-700 hover:bg-slate-700"
                  title="Settings"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </button>
              </div>
            </div>
            <div className={`p-4 rounded-xl mb-4 border-2 transition-all ${editingIndex !== null ? 'border-yellow-500 bg-slate-900' : 'border-slate-700 bg-slate-900'}`}>
              <div className="grid grid-cols-4 gap-2 mb-2">
                <div className="col-span-1">
                  <label className="text-[10px] text-slate-400">Reps</label>
                  <input type="number" value={inReps} onChange={e => setInReps(e.target.value)} className="w-full bg-black p-2 rounded text-lg border border-slate-700" />
                </div>
                <div className="col-span-3">
                  <label className="text-[10px] text-slate-400">Description</label>
                  <input type="text" value={inDist} onChange={e => setInDist(e.target.value)} className="w-full bg-black p-2 rounded text-lg border border-slate-700" />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div><label className="text-[10px] text-slate-400">Min</label><input type="number" value={inMin} onChange={e => setInMin(e.target.value)} className="w-full bg-black p-2 rounded border border-slate-700" /></div>
                <div><label className="text-[10px] text-slate-400">Sec</label><input type="number" value={inSec} onChange={e => setInSec(e.target.value)} className="w-full bg-black p-2 rounded border border-slate-700" /></div>
              </div>
              <button onClick={handleAddOrUpdate} className={`w-full py-3 rounded-lg font-bold ${editingIndex !== null ? 'bg-yellow-600 text-black' : 'bg-blue-600'}`}>
                {editingIndex !== null ? 'SAVE CHANGES' : 'ADD SET'}
              </button>
            </div>
            <div className="scroll-container">
              {workout.map((b, i) => (
                <div key={i} onClick={() => { if(b.type!=='rest') { setEditingIndex(i); setInReps(b.reps.toString()); setInDist(b.dist); setInMin(Math.floor(b.interval/60).toString()); setInSec((b.interval%60).toString()); }}} className={`flex justify-between p-3 rounded mb-2 border-l-4 ${editingIndex === i ? 'border-yellow-500 bg-slate-800' : b.type === 'rest' ? 'bg-orange-950/40 border-orange-500' : 'bg-black border-blue-600'}`}>
                  <span>{b.type === 'rest' ? `REST: ${formatTime(b.duration)}` : `${b.reps}x${b.dist} @ ${formatTime(b.interval)}`}</span>
                  <button onClick={(e) => { e.stopPropagation(); setWorkout(workout.filter((_, idx) => idx !== i)); }} className="text-red-500 font-bold px-2">✕</button>
                </div>
              ))}
            </div>
            <div className="fixed bottom-0 left-0 right-0 p-4 bg-slate-950 border-t border-slate-800 flex gap-2">
               <input type="number" value={defaultRest} onChange={e => setDefaultRest(e.target.value)} className="w-20 bg-black p-2 rounded border border-slate-800 text-center" />
               <button onClick={() => { setMode('RUN'); setCurrentBlockIndex(0); setCurrentRep(1); setTimer(0); startTimeRef.current = null; accumulatedTimeRef.current = 0; }} className="bg-green-600 rounded-lg font-bold flex-grow">START PRACTICE</button>
            </div>
          </div>
        );
      }

      // --- RUN MODE ---
      if (!block) {
        // Release touch lock when practice ends
        if (touchLocked) setTouchLocked(false);
        return (
          <div className="h-screen bg-black flex flex-col items-center justify-center">
            <h1 className="text-green-500 text-4xl font-bold mb-8">PRACTICE OVER</h1>
            <button onClick={() => setMode('SETUP')} className="bg-blue-600 px-10 py-4 rounded-xl font-bold">RESTART</button>
          </div>
        );
      }

      const limit = isRest ? block.duration : block.interval;
      const remaining = limit - timer;

      let pulseClass = "";
      if (isActive) {
        if (timer === 0 && !isRest) {
          pulseClass = "do-flash-green";
        } else if (remaining <= 3 && remaining > 0) {
          if (isRest) {
            pulseClass = "do-pulse-rest-final";
          } else {
            const nextIsRest = (currentRep >= block.reps);
            pulseClass = nextIsRest ? "do-pulse-orange" : "do-pulse-red";
          }
        }
      }

      const handleTimerClick = () => {
        if (touchLocked) return; // Ignore touch when locked
        setIsActive(!isActive);
        if (!isActive) {
          // Resuming - reset start time
          startTimeRef.current = Date.now();
          accumulatedTimeRef.current = timer;
        }
      };

      return (
        <div
          key={tickToken}
          className={`h-screen flex flex-col transition-colors duration-300 relative ${isRest ? 'bg-orange-500' : 'bg-black'} ${pulseClass} ${touchLocked ? 'touch-locked' : ''}`}
          onClick={handleTimerClick}
        >
          {/* Touch Lock Indicator */}
          {touchLocked && (
            <div className="absolute top-4 left-1/2 -translate-x-1/2 z-30 bg-red-600 text-white px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2">
              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
              </svg>
              TOUCH LOCKED - Press {unlockKey === 'VolumeUp' ? 'Vol+' : unlockKey === 'VolumeDown' ? 'Vol-' : unlockKey}
            </div>
          )}

          <div className="p-2 md:p-4 flex justify-between items-start z-10">
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (touchLocked) return;
                setMode('SETUP');
                setIsActive(false);
                setTouchLocked(false);
              }}
              className={`px-3 py-1 md:px-4 md:py-2 rounded font-bold border-2 text-sm md:text-base ${isRest ? 'border-black text-black' : 'border-slate-800 text-slate-500'} ${touchLocked ? 'opacity-50' : ''}`}
            >
              EDIT
            </button>
            <div className={`text-right ${isRest ? 'text-black' : 'text-white'}`}>
              <div className="text-base md:text-xl font-bold uppercase">{isRest ? 'Rest' : block.dist}</div>
              {!isRest && <div className="text-sm md:text-lg opacity-80">Rep {currentRep} / {block.reps}</div>}
            </div>
          </div>
          <div className="flex-grow flex items-center justify-center z-10 overflow-hidden">
            <span className={`digital-font font-bold timer-display ${isRest ? 'text-black' : 'text-red-600'}`}>
              {formatTime(timer)}
            </span>
          </div>
          {!isActive && !touchLocked && (
            <div className="absolute inset-0 flex items-center justify-center bg-black/40 z-20">
              <div className="text-yellow-400 text-2xl md:text-4xl font-bold border-4 border-yellow-400 p-3 md:p-4">PAUSED</div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
